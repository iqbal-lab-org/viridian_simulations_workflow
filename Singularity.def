Bootstrap: library
From: ubuntu:20.04

%environment
export PATH=/bioinf-tools/:$PATH
export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
export LANG=C.UTF-8


%setup
    mkdir $SINGULARITY_ROOTFS/viridian_simulations_workflow
    rsync -a requirements.txt error_modes.py config.yml LICENSE README.md V3 V4 V4.1 reference_genome.fasta Snakefile $SINGULARITY_ROOTFS/viridian_simulations_workflow/


%post
    #_____________________ setup $PATH _______________________#
    export PATH=/bioinf-tools/:$PATH
    export LANG=C.UTF-8
    export DEBIAN_FRONTEND=noninteractive

    cd /viridian_simulations_workflow
    # apt-get install python and git
    apt-get update
    apt install -y software-properties-common
    add-apt-repository universe
    apt-get install -y \
        cmake \
        gcc-10 \
        g++-10 \
        git \
        python3 \
        python3-pip \
        python3-setuptools \
        python3-dev \
        wget \
        build-essential \
        libssl-dev \
        zlib1g-dev \
        libbz2-dev \
        liblzma-dev \
        uuid-dev \
        libgpgme11-dev \
        squashfs-tools \
        libseccomp-dev \
        pkg-config \
        cryptsetup
    # use gcc and g++-10
    update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-10 100 --slave /usr/bin/g++ g++ /usr/bin/g++-10 --slave /usr/bin/gcov gcov /usr/bin/gcov-10
    # pip install required packages
    pip3 install -r requirements.txt
    # install VGsim
    git clone https://github.com/Genomics-HSE/VGsim.git
    cd VGsim
    python3 -m pip install .
    cd ..
    # install ART
    wget https://www.niehs.nih.gov/research/resources/assets/docs/artbinmountrainier2016.06.05linux64.tgz && \
        tar -xzf artbinmountrainier2016.06.05linux64.tgz
    # install bwa
    git clone https://github.com/lh3/bwa.git
    cd bwa
    make
    cd ..
    # install minimap2
    git clone https://github.com/lh3/minimap2.git
    cd minimap2
    make
    cd ..
    # install racon
    git clone --recursive https://github.com/lbcb-sci/racon.git racon-git
    cd racon-git
    mkdir build
    cd build
    cmake -DCMAKE_BUILD_TYPE=Release ..
    make CC=gcc-10 CPP=g++-10 CXX=g++-10 LD=g++-10
    cd ../../
    cp -s racon-git/build/bin/racon .
    # install viridian workflow
    git clone https://github.com/iqbal-lab-org/viridian_workflow.git
    cd viridian_workflow
    python3 -m pip install .
    cd ..

%runscript
    "$@"