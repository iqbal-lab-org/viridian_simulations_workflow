Bootstrap: library
From: ubuntu:20.04

%setup
    mkdir ${SINGULARITY_ROOTFS}/viridian_simulations_workflow
    rsync -a requirements.txt error_modes.py LICENSE README.md V3 V4 V4.1 ${SINGULARITY_ROOTFS}/viridian_simulations_workflow/


%post
    export DEBIAN_FRONTEND=noninteractive

    cd ${SINGULARITY_ROOTFS}/viridian_simulations_workflow
    # apt-get install python and git
    apt-get update
    apt install -y software-properties-common
    add-apt-repository universe
    apt-get install -y \
        cmake \
        gcc-10 \
        g++-10 \
        git \
        python-is-python3 \
        python3-pip \
        python3-setuptools \
        python3-dev \
        wget \
        build-essential \
        libssl-dev \
        zlib1g-dev \
        libbz2-dev \
        liblzma-dev \
        uuid-dev \
        libgpgme11-dev \
        squashfs-tools \
        libseccomp-dev \
        pkg-config \
        cryptsetup \
        libncurses5-dev \
        libcurl4-openssl-dev
    # use gcc and g++-10
    update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-10 100 --slave /usr/bin/g++ g++ /usr/bin/g++-10 --slave /usr/bin/gcov gcov /usr/bin/gcov-10
    # pip install required packages
    pip3 install -r requirements.txt
    # install VGsim
    git clone https://github.com/Genomics-HSE/VGsim.git
    cd VGsim
    git checkout 018d02f7f41ee844db61a27a3f643903dd4cff12
    python -m pip install git+https://github.com/ev-br/mc_lib.git@v0.4
    python -m pip install -e .
    cd ..
    # install ART
    wget https://www.niehs.nih.gov/research/resources/assets/docs/artbinmountrainier2016.06.05linux64.tgz && \
        tar -xzf artbinmountrainier2016.06.05linux64.tgz
    # install minimap2
    git clone https://github.com/lh3/minimap2.git
    cd minimap2
    make CC=gcc-10 CPP=g++-10 CXX=g++-10 LD=g++-10
    cd ..
    # install bwa
    git clone https://github.com/lh3/bwa.git
    cd bwa
    make
    cd ..
    # install htslib and samtools
    wget https://github.com/samtools/htslib/releases/download/1.14/htslib-1.14.tar.bz2
    tar -vxjf htslib-1.14.tar.bz2
    cd htslib-1.14
    make
    cd ..
    wget https://github.com/samtools/samtools/releases/download/1.14/samtools-1.14.tar.bz2
    tar -vxjf samtools-1.14.tar.bz2
    mv samtools-1.14 samtools && cd samtools
    ./configure
    make
    cd ..
    # install bedtools
    git clone https://github.com/arq5x/bedtools2
    cd bedtools2
    make
    make install
    cd ..
    # install racon
    git clone --recursive https://github.com/lbcb-sci/racon.git
    cd racon
    mkdir build
    cd build
    cmake -DCMAKE_BUILD_TYPE=Release ..
    make CC=gcc-10 CPP=g++-10 CXX=g++-10 LD=g++-10
    cd ../../
    # install viridian workflow
    git clone https://github.com/iqbal-lab-org/viridian_workflow.git
    git clone https://github.com/jeff-k/viridian_workflow.git
    cd viridian_workflow
    git checkout self_qc
    python -m pip install .
    cd ..
    # install varifier
    git clone https://github.com/iqbal-lab-org/varifier.git
    cd varifier
    git checkout 9ad87db9d501e17c008716f53c386500d4ba8f63
    python -m pip install .
    cd ..

    # Add the pipeline scripts to the $PATH
    echo 'export PATH=$PATH:/viridian_simulations_workflow' >> $SINGULARITY_ENVIRONMENT


%files

    # Copy test data files
    error_modes.py /viridian_simulations_workflow
    Snakefile /viridian_simulations_workflow


%runscript
    snakemake "$@"